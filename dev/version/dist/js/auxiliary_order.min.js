$(function(){function e(e){var t=e.body;t&&(w=t.is_ach_enabled)}function t(e){window.location="/invest_success.html?order_number="+u+"&payment_method="+f+"&bank_name="+b+"&account_number="+v+"&product_id="+c}function n(e){var t=e.body;if(t&&null!=t){$("#signaturePage").show(),$(".product_name").html(t.product_name),$(".return_rate").html("预计年化收益："+t.return_rate+"%"),$(".invest_term").html("投资期限："+t.invest_term+"个月"),p=t.min_invest_amount,h=t.invest_par_value,$(".invest-amounts").val(p),h<1e4?$(".invest-par-value").html(t.invest_par_value):$(".invest-par-value").html(h/1e4+"万"),$(".product_name").html(t.product_name),$(".full_name").html(t.order_user_info.first_name+" "+t.order_user_info.last_name),$(".phone").html(t.order_user_info.phone),$(".email").html(t.order_user_info.email);var n=t.order_user_info.base_info;$(".date_of_birth").html(n.date_of_birth),$(".source_of_capital").html(n.source_of_capital),$(".industry").html(n.industry),$(".occupation").html(n.occupation),$(".passport_number").html(t.order_user_info.passport_number),$(".passport_expire_date").html(t.order_user_info.passport_expire_date);var a=t.order_user_info.address_cn;if($(".line-1").html(a.region+" "+a.city+" "+a.district),$(".line-2").html(a.detail.replace(/\r\n|\r|\n/,", ")),$(".line-3").html(a.postal_code),"US"==t.order_user_info.bank_type){var r=t.order_user_info.bank_us;b=r.bank_name,$(".bank_name").html(b),$(".bank_address").html(r.bank_address.replace(/\r\n|\r|\n/,", ")),$(".routing_number").show().html(r.routing_number),$(".swift_code").html(r.swift_code),v=r.account_number.replace(/^\d+(\d{4})$/,"$1"),$(".account_number").html("****************"+v)}else{var i=t.order_user_info.bank_non_us;b=i.bank_name,$(".bank_name").html(b),$(".bank_address").html(i.bank_address.replace(/\r\n|\r|\n/,", ")),$(".swift_code").html(i.swift_code),v=i.account_number.replace(/^\d+(\d{4})$/,"$1"),$(".account_number").html("****************"+v),i.have_middle_bank&&($(".middle_bank").show(),$(".middle_bank_name").html(i.middle_bank_name),$(".middle_bank_address").html(i.middle_bank_address),$(".middle_bank_swift_code").html(i.middle_bank_swift_code)),$("#invest_value .payment").html('<div class="checkbox"><label><input type="checkbox" checked value="wire" disabled>通过银行电汇线下打款</label></div>')}var o="";_=t.order_user_info,$.each(t.product_document,function(e,t){o+=t.need_mapped?'<div class="checkbox"><a data-id="'+t.id+'" class="getPdf">'+t.document_name+"</a></div>":'<div class="checkbox"><a data-url="'+t.document_url+'" class="getPdf">'+t.document_name+"</a></div>"}),$(".document-item").html(o),w&&"US"==t.order_user_info.bank_type?($("#invest_value .payment").html('<p style="color: #000;margin-bottom: 5px;">入金方式只能选择其中一项：</p><div class="radio"><label><input type="radio" name="optionsRadios" checked value="ach">通过ACH自动从'+b+"（"+v+'）扣款</label></div><div class="radio"><label><input type="radio" name="optionsRadios" value="wire">通过银行电汇线下打款</label></div>'),$(".document-item").append('<div class="checkbox ach"><a data-url="/vendor/doc/ACH.pdf" class="getPdf">ACH自动扣款协议</a></div>'),$(".showAch").html("- 我确认"+b+" ("+v+")账户里面有充足的资金并授权美信金融使用ACH从此账户扣款。")):$("#invest_value .payment").html('<div class="checkbox"><label><input type="checkbox" checked value="wire" disabled>通过银行电汇线下打款</label></div>')}}function a(e){$("#document-loading").hide(),$("#document-element-wrapper").html('<iframe id="document-preview-element" src="/vendor/pdfjs/web/viewer.html?file='+e+'#page=1"></iframe>'),$("#document-preview-element").width($(window).width()),$("#document-preview-element").height($(window).height()-45),$("#document-preview-element").css("margin-top","40px")}function r(){$("#document-element-wrapper").html(""),$("#document-preview").width("0%")}function i(e){var t=e.body;if(t){if("FOR_INVEST"!==t.status)return window.location="/auxiliary_order/errLink.html",!1;$(".beforeOpen p").html("请输入密码打开“"+t.name+"”产品投资文件")}}function o(e){alert(e.msg)}$("#signature-line").jSignature({width:800,height:200});var d=$("#signature-line").jSignature("getData"),s=getUrlParam("phone")||"",l=getUrlParam("partner_id")||"",c=getUrlParam("product_id")||"",u=getUrlParam("order_number")||"",m=getUrlParam("access_token")||"",_=null,p=0,h=0,v="",b="",f="";getData({url:base_url+"/white_label/product_info",data:{product_id:c},sucFn:i,failFn:o});var w=!1;""!=c&&getData({url:base_url+"/white_label/product/payment_list",data:{product_id:c},async:!1,sucFn:e,failFn:o}),getData({url:base_url+"/zion/common/openSignature",data:{order_number:u,phone:s,channel_code:l,access_token:m},async:!1,sucFn:n,failFn:o}),$(".show-user-info a").on("click",function(){$(".user-info").show(),$(".show-user-info").hide()}),$(".hide-info").on("click",function(){$(".user-info").hide(),$(".show-user-info").show()}),$("#update_order").on("click",function(){$("#signature-box,.invest-amounts").css("border","1px solid #ccc"),$(".document-unCheck").remove(),$(this).prop("disabled",!0);var e=parseInt($(".invest-amounts").val())||p;if(f=$('.payment input[type="radio"]:checked').val()||"wire",e<p||(e-p)%h!=0)return $(".invest-amounts").css("border-color","red"),$("body").scrollTop($(".invest-amounts").offset().top),$(this).prop("disabled",!1),!1;var n=$("#signature-line").jSignature("getData");if(n==d)return $(this).prop("disabled",!1),$("#signature-box").css("border","1px solid red"),$("body").scrollTop($("#signature-box").offset().top),!1;var a={};return a.order_number=u,a.signature=n,a.channel_code=l,a.invest_amount=e,a.payment_method=f,a.phone=s,a.access_token=m,postData({url:base_url+"/zion/common/updateSignature",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",sucFn:t,failFn:o}),!1}),$(".document-item").on("click",".getPdf",function(){$("#document-preview").width("100%"),$("#document-loading").show();var e=$(this).data("id");if(!e){var t=$(this).data("url");return void a(t)}return _.document_id=e,$.ajax({type:"post",url:base_url+"/channel/doc/preview",contentType:"application/json; charset=utf-8",data:JSON.stringify(_),success:function(e){a(e.body)}}),!1}),$("#document-preview .close-document-preview").click(function(){r()}),$(".add").click(function(){var e=parseInt($(".invest-amounts").val());return""==e||isNaN(e)?$(".invest-amounts").val(p):(e+=h,$(".invest-amounts").val(e)),e<=p?$(".sub").prop("disabled",!0):$(".sub").prop("disabled",!1),!1}),$(".sub").click(function(){var e=parseInt($(".invest-amounts").val());if(e<=p)$(this).prop("disabled",!0);else{if(e-=h,e<p)return!1;$(".invest-amounts").val(e)}return!1}),$('.radio input[type="radio"]').on("change",function(){"ach"==$(this).val()?($(".ach").empty(),$(".document-info .ach").html('<a data-url="/vendor/doc/ACH.pdf" class="getPdf">ACH自动扣款协议</a>'),$(".signature .ach").html("- 我确认"+b+" ("+v+")账户里面有充足的资金并授权美信金融使用ACH从此账户扣款。")):$(".ach").empty()})});